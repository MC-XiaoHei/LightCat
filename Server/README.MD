## LightCat

![](https://img.shields.io/badge/license-MIT--License-brightgreen)

### 功能简介：
***
在任意两台设备间建立高速率P2P隧道。

LightCat会在可以直接打洞时直接建立连接，在无法直接打洞时使用同时利用LightCat网络中的多个其他设备作为中继，转发数据。

### 概念定义：
***
在本项目中，我们：
* 将公网设备定义为网络环境是None NAT的设备；
* 将NAT 1，NAT 2，NAT 3设备定义为网络环境是Easy NAT的设备；
* 将NAT 4设备定义为网络环境是Hard NAT的设备；
* 将一对IP，端口定义为一个地址

### 网络结构：
***
LightCat网络中存在三种节点，分别为：
* **中心节点**（Center Node），简称CN，在整个网络中**只有一个**，需要拥有**至少三个**公网端口，承担用户注册，节点管理，中继节点选择，网络环境查询，隧道鉴权等任务。
* **用户节点**（User Node），简称UN，承担负载均衡的作用。
* **中继节点**（Relay Node），简称RN，不能是Hard NAT网络环境，用于**中继**数据。

### 打洞流程：
***
要建立连接，自然，我们有两个UN，我们分别记为UN1，UN2。CN提供两个端口，能返回**请求者**的公网地址，UN1，UN2使用这两个端口判断自己的网络环境。

**若两个端口返回的地址相同，则为Easy NAT，不同为Hard NAT。**

此时分为三种情况：
* 双方网络环境均不是Hard NAT。此时，两个UN均向CN发送一个带有同样密钥与各自的账号Token的请求，CN首先验证Token，然后因为请求有先后，CN向发送较晚的UN（假设是UN2）发送UN1的地址， UN2向这个地址发送请求包， 然后UN2向CN发送完成包，CN收到后向UN1发送UN2的地址， 此时UN2便收到了UN1发来的包，迅速向UN1发回确认包，UDP连接建立成功。
* 双方中有且仅有一个Hard NAT（假设为UN1）。此时，两个UN均向CN发送一个带有同样密钥以及各自的网络环境与账号Token的请求，CN同样验证Token，然后等待双方均连接到CN，之后CN向UN1发送UN2的地址，**同时**向UN2发送UN1的IP，UN1收到后以100Packets每秒的速度使用**不同的**内网端口向UN2的地址发包并监听（由于Hard NAT特性此时外网端口是随机的），UN2收到后同样以100Packets每秒的速度向UN1的随机端口发包并监听（随机端口不重复）。当UN1收到包，立即停止发包并向UN2返回确认包，UDP连接建立成功。若10s（发送1000个Packets）后UN1仍未收到包，UDP连接建立失败（通常这种情况几乎不可能发生）。
* 双方均为Hard NAT，这种情况需要借助LightCat网络进行中继。两个UN均向CN发送一个带有同样密钥以及各自的经纬度（由IP地址粗略得到）与账号Token的请求，CN验证Token后，根据双方经纬度选择多个合适的中继服务器，具体数量根据双方账号信息中的带宽限制而定，这些节点组成了**此隧道的RN列表**。此时因为RN的网络环境必然是Easy NAT，所以双方均使用前面所提到的方法**分别与RN列表中的每个RN建立连接**，然后，由RN进行中转，我们便实现了**多条**P2P隧道的连接。

